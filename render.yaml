# Render Blueprint Configuration
# This file configures all services for the Omnichannel AI Platform

services:
  # 1. Node.js Backend API Service
  - type: web
    name: omnichannel-ai-api
    runtime: node
    buildCommand: chmod +x server/render-build.sh && ./server/render-build.sh
    startCommand: chmod +x server/render-start.sh && ./server/render-start.sh
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: omnichannel-ai-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: omnichannel-ai-redis
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: CLERK_SECRET_KEY
        sync: false
      - key: CLERK_PUBLISHABLE_KEY
        sync: false
      - key: EXOTEL_API_KEY
        sync: false
      - key: EXOTEL_API_TOKEN
        sync: false
      - key: EXOTEL_SID
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: META_APP_ID
        sync: false
      - key: META_APP_SECRET
        sync: false
      - key: META_ACCESS_TOKEN
        sync: false
      - key: WHATSAPP_PHONE_NUMBER_ID
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: AZURE_TTS_KEY
        sync: false
      - key: AZURE_TTS_REGION
        sync: false
      - key: VOICE_BRIDGE_URL
        fromService:
          type: web
          name: omnichannel-ai-voice
          property: host
    healthCheckPath: /health
    autoDeploy: true
    plan: standard

  # 2. Python Voice Bridge Service
  - type: web
    name: omnichannel-ai-voice
    runtime: python
    buildCommand: chmod +x server/voice-bridge/render-build.sh && ./server/voice-bridge/render-build.sh
    startCommand: chmod +x server/voice-bridge/render-start.sh && ./server/voice-bridge/render-start.sh
    envVars:
      - key: PYTHONPATH
        value: .
      - key: PORT
        value: 10000
      - key: NODE_API_URL
        fromService:
          type: web
          name: omnichannel-ai-api
          property: host
      - key: AZURE_TTS_KEY
        sync: false
      - key: AZURE_TTS_REGION
        sync: false
      - key: EXOTEL_API_KEY
        sync: false
      - key: EXOTEL_API_TOKEN
        sync: false
      - key: EXOTEL_SID
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: WHISPER_MODEL
        value: base
    healthCheckPath: /health
    autoDeploy: true
    plan: standard

  # 3. React Frontend (Static Site)
  - type: static
    name: omnichannel-ai-web
    buildCommand: cd web && npm install && npm run build
    publishPath: ./web/dist
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: omnichannel-ai-api
          property: host
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false
    routes:
      - type: rewrite
        source: /api/*
        destination: https://omnichannel-ai-api.onrender.com/api/$1
      - type: rewrite
        source: /webhooks/*
        destination: https://omnichannel-ai-api.onrender.com/webhooks/$1
      - type: rewrite
        source: /*
        destination: /index.html
    autoDeploy: true

databases:
  # PostgreSQL Database with pgvector support
  - name: omnichannel-ai-db
    databaseName: omnichannel_ai
    user: omnichannel_ai_user
    plan: standard
    postgresMajorVersion: 15
    ipAllowList: []

  # Redis for caching and queues
  - type: redis
    name: omnichannel-ai-redis
    plan: starter
    ipAllowList: []

# Background Worker (Optional - if you want to run workers separately)
# - type: worker
#   name: omnichannel-ai-worker
#   runtime: node
#   buildCommand: cd server && npm install && npm run build
#   startCommand: cd server && npm run worker
#   envVars:
#     - key: NODE_ENV
#       value: production
#     - key: DATABASE_URL
#       fromDatabase:
#         name: omnichannel-ai-db
#         property: connectionString
#     - key: REDIS_URL
#       fromService:
#         type: redis
#         name: omnichannel-ai-redis
#         property: connectionString
#   autoDeploy: true

// Omnichannel AI Platform - Prisma Schema
// Super Admin → Business → Customer Architecture
// With Vocode + Exotel (India) + Twilio (International) Telephony

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================
// SUPER ADMIN (Managed by Clerk)
// ============================================

model Admin {
  id        String   @id @default(uuid())
  clerkId   String   @unique // Clerk user ID for super admin
  email     String   @unique
  name      String?
  role      String   @default("ADMIN") // ADMIN, SUPER_ADMIN
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@map("admins")
}

// ============================================
// BUSINESS (Client Entity - Managed by Super Admin)
// ============================================

model Business {
  id          String   @id @default(uuid())
  clerkId     String?  @unique // Optional Clerk user ID for business owner
  apiKey      String?  @unique // API key for programmatic access
  name        String
  industry    String?
  email       String   @unique
  phone       String?
  
  // AI Configuration (Per Business)
  aiConfig    Json?    // Personality, tone, custom prompts
  
  // Channel Enablement
  enabledChannels Channel[] @default([VOICE, CHAT, EMAIL, SMS, TELEGRAM, WHATSAPP, INSTAGRAM])
  
  // Service Configuration
  aiModel            String   @default("gpt-4o-mini")
  ttsProvider        String   @default("azure")
  ttsVoiceId         String   @default("en-US-JennyNeural")
  defaultLanguage    String   @default("en")
  supportedLanguages String[] @default(["en"])
  
  // Voice Provider Configuration
  voiceProvider      String?  // "twilio" or "exotel"
  twilioPhoneNumber  String?
  exotelPhoneNumber  String?
  
  // Subscription & Tier
  tier        String   @default("STARTER") // STARTER, GROWTH, ENTERPRISE
  
  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  customers        Customer[]
  credits          BusinessCredit?
  faqs             BusinessFAQ[]
  crmIntegrations  CRMIntegration[]
  rateLimitConfigs RateLimitConfig[]
  abTests          ABTest[]

  @@index([email])
  @@index([isActive])
  @@index([clerkId])
  @@index([apiKey])
  @@map("businesses")
}

// ============================================
// BUSINESS CREDITS & BUDGET
// ============================================

model BusinessCredit {
  id                  String   @id @default(uuid())
  businessId          String   @unique
  
  // Plan Type
  planType            String   @default("STARTER") // STARTER, GROWTH, ENTERPRISE
  
  // Credit System
  totalCredits        Decimal  @default(0) @db.Decimal(12, 2)
  usedCredits         Decimal  @default(0) @db.Decimal(12, 2)
  availableCredits    Decimal  @default(0) @db.Decimal(12, 2)
  
  // Monthly Budget (Hard Cap)
  monthlyBudget       Decimal  @default(100) @db.Decimal(10, 2)
  currentMonthSpend   Decimal  @default(0) @db.Decimal(10, 2)
  lastResetAt         DateTime @default(now())
  
  // Alerts
  alertThresholds     Int[]    @default([75, 90])
  lastAlertAt75       DateTime?
  lastAlertAt90       DateTime?
  
  // Controls
  isPaused            Boolean  @default(false)
  pausedAt            DateTime?
  pauseReason         String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_credits")
}

// ============================================
// CUSTOMER (End User Entity)
// ============================================

model Customer {
  id         String   @id @default(uuid())
  businessId String
  email      String?
  password   String?  // Hashed password for customer auth
  phone      String?  // Primary identifier for voice/SMS
  name       String?
  
  // AI Configuration (Per Customer overrides)
  aiConfig        Json?
  enabledChannels Channel[] @default([VOICE, CHAT, EMAIL, SMS, TELEGRAM, WHATSAPP, INSTAGRAM])
  
  // Metadata
  metadata     Json?    // Custom fields
  preferences  Json?    // Language, timezone, notifications
  tags         String[] // For segmentation
  
  // Trust & Verification
  trustScore       Int       @default(50) // 0-100
  isVerified       Boolean   @default(false)
  isBlocked        Boolean   @default(false)
  firstInteraction DateTime  @default(now())
  lastInteraction  DateTime  @default(now())
  
  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  business        Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  conversations   Conversation[]
  memories        Memory[]
  costLogs        CostLog[]
  campaigns       Campaign[]
  responseCaches  ResponseCache[]
  credits         CustomerCredit?

  @@unique([businessId, phone])
  @@unique([businessId, email])
  @@index([businessId])
  @@index([phone])
  @@index([email])
  @@index([isActive])
  @@map("customers")
}

// ============================================
// CUSTOMER CREDITS (Optional - for customer-level billing)
// ============================================

model CustomerCredit {
  id                  String   @id @default(uuid())
  customerId          String   @unique
  
  // Credit System
  totalCredits        Decimal  @default(0) @db.Decimal(12, 2)
  usedCredits         Decimal  @default(0) @db.Decimal(12, 2)
  availableCredits    Decimal  @default(0) @db.Decimal(12, 2)
  
  // Monthly Budget
  monthlyBudget       Decimal  @default(100) @db.Decimal(10, 2)
  currentMonthSpend   Decimal  @default(0) @db.Decimal(10, 2)
  lastResetAt         DateTime @default(now())
  
  // Controls
  isPaused            Boolean  @default(false)
  pausedAt            DateTime?
  pauseReason         String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@map("customer_credits")
}

// ============================================
// CONVERSATION & MESSAGING
// ============================================

enum Channel {
  VOICE
  CHAT
  EMAIL
  SMS
  TELEGRAM
  WHATSAPP
  INSTAGRAM
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  TRANSFERRED
  HUMAN_HANDOFF
  COMPLETED
}

model Conversation {
  id         String             @id @default(uuid())
  businessId String
  customerId String
  channel    Channel
  status     ConversationStatus @default(ACTIVE)
  summary    String? // AI-generated summary
  metadata   Json? // Channel-specific data
  startedAt  DateTime           @default(now())
  endedAt    DateTime?
  updatedAt  DateTime           @updatedAt

  // Relationships
  customer       Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages       Message[]
  callRecordings CallRecording[]
  costLogs       CostLog[]

  @@index([businessId])
  @@index([customerId])
  @@index([channel])
  @@index([status])
  @@index([startedAt])
  @@map("conversations")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  role           MessageRole
  content        String        @db.Text
  channel        Channel
  status         MessageStatus @default(SENT)
  metadata       Json? // Attachments, reactions, delivery status
  
  // Cost tracking per message
  aiCost         Decimal?      @db.Decimal(10, 6)
  embeddingCost  Decimal?      @db.Decimal(8, 6)
  cachedResponse Boolean       @default(false)
  
  createdAt      DateTime      @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([cachedResponse])
  @@map("messages")
}

// ============================================
// UNIFIED MEMORY SYSTEM
// ============================================

model Memory {
  id         String                        @id @default(uuid())
  customerId String
  content    String                        @db.Text
  embedding  Unsupported("vector(1536)")?
  source     String? // conversation_id, file_name, etc.
  metadata   Json?
  createdAt  DateTime                      @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("memories")
}

// ============================================
// VOICE-SPECIFIC DATA
// ============================================

model CallRecording {
  id             String   @id @default(uuid())
  conversationId String
  provider       String   @default("exotel") // exotel, twilio
  recordingUrl   String? // URL to download recording
  duration       Int? // Call duration in seconds
  transcription  String?  @db.Text
  metadata       Json? // Caller ID, status, etc.
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("call_recordings")
}

// ============================================
// COST TRACKING
// ============================================

model CostLog {
  id               String   @id @default(uuid())
  businessId       String
  customerId       String
  conversationId   String?
  
  // Service Details
  service          String   // OPENAI_GPT, AZURE_TTS, EXOTEL_SMS, etc.
  cost             Decimal  @db.Decimal(10, 6)
  tokensUsed       Int?     // For AI calls
  durationSeconds  Int?     // For voice calls
  
  // Context
  channel          Channel?
  model            String?  // GPT-4o-mini, etc.
  
  // Metadata
  metadata         Json?
  
  createdAt        DateTime @default(now())

  customer       Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversation   Conversation?  @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  
  @@index([businessId, createdAt])
  @@index([customerId, createdAt])
  @@index([businessId, service])
  @@index([service, createdAt])
  @@index([createdAt])
  @@map("cost_logs")
}

// ============================================
// SEMANTIC CACHE SYSTEM
// ============================================

model ResponseCache {
  id              String   @id @default(uuid())
  businessId      String
  customerId      String
  
  // Embedding Identification
  embeddingHash   String
  queryVector     Unsupported("vector(1536)")?
  
  // Cached Content
  query           String   @db.Text
  queryText       String   @db.Text
  queryNormalized String   @db.Text
  responseText    String   @db.Text
  contextHash     String?
  
  // Cache Metadata
  hitCount        Int      @default(1)
  similarityScore Decimal  @default(0.92)
  lastAccessedAt  DateTime @default(now())
  expiresAt       DateTime
  
  // Source Tracking
  sourceChannel   String?
  isFAQ           Boolean  @default(false)
  
  // Quality Metrics
  avgRating       Decimal? @db.Decimal(3, 2)
  feedbackCount   Int      @default(0)
  
  createdAt       DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, embeddingHash])
  @@index([businessId, expiresAt])
  @@index([businessId, isFAQ])
  @@index([customerId, expiresAt])
  @@index([lastAccessedAt])
  @@map("response_caches")
}

model BusinessFAQ {
  id              String   @id @default(uuid())
  businessId      String
  
  // Content
  question        String   @db.Text
  questionVariants String[]
  answer          String   @db.Text
  category        String?
  
  // Vector for Semantic Matching
  embedding       Unsupported("vector(1536)")?
  
  // Stats
  hitCount        Int      @default(0)
  lastHitAt       DateTime?
  
  // Status
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  
  // Auto-Extraction
  autoExtracted   Boolean  @default(false)
  extractedFrom   String?
  confidence      Decimal?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId, category])
  @@index([businessId, isActive])
  @@index([businessId, priority])
  @@map("business_faqs")
}

// ============================================
// CAMPAIGNS
// ============================================

enum CampaignType {
  SCHEDULED
  EVENT_BASED
  REMINDER
  PROMOTION
  FOLLOW_UP
  ABANDONED_CART
  APPOINTMENT_REMINDER
  BIRTHDAY
  CUSTOM
}

enum CampaignTrigger {
  SCHEDULED
  EVENT_BASED
  BEHAVIORAL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

model Campaign {
  id           String   @id @default(uuid())
  businessId   String
  customerId   String
  
  // Basic Info
  name         String
  description  String?
  type         CampaignType
  
  // Trigger Configuration
  triggerType  CampaignTrigger
  triggerConfig Json?
  scheduledAt  DateTime?
  
  // Targeting
  targetFilter Json?    // Customer segment rules
  channel      Channel
  
  // Content
  messageTemplate String @db.Text
  aiPersonalized Boolean @default(false)
  
  // Execution
  startedAt    DateTime?
  completedAt  DateTime?
  status       CampaignStatus @default(DRAFT)
  
  // Stats
  totalTargeted Int      @default(0)
  totalSent     Int      @default(0)
  totalFailed   Int      @default(0)
  totalReplied  Int      @default(0)
  totalConverted Int     @default(0)
  
  // Cost Tracking
  estimatedCost  Decimal?
  actualCost     Decimal  @default(0)
  
  // Error Handling
  errorMessage   String?
  retryCount     Int      @default(0)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  abTests  ABTest[]
  
  @@index([businessId, status])
  @@index([businessId, type])
  @@index([customerId, status])
  @@index([scheduledAt])
  @@index([status, scheduledAt])
  @@map("campaigns")
}

// ============================================
// A/B TESTING
// ============================================

enum WinnerCriteria {
  OPEN_RATE
  CLICK_RATE
  REPLY_RATE
  CONVERSION_RATE
}

model ABTest {
  id              String   @id @default(uuid())
  businessId      String
  campaignId      String
  
  // Test Configuration
  name            String
  description     String?
  variants        Json     // Array of variant objects
  winnerCriteria  WinnerCriteria @default(OPEN_RATE)
  confidenceLevel Decimal  @default(0.95)
  sampleSize      Int?
  
  // Results
  winner          String?
  winningVariant  String?
  results         Json?
  
  // Status
  status          String   @default("DRAFT") // DRAFT, RUNNING, COMPLETED
  startedAt       DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([campaignId])
  @@map("ab_tests")
}

// ============================================
// CRM INTEGRATION
// ============================================

enum CRMProvider {
  SALESFORCE
  HUBSPOT
  ZOHO
  FRESHSALES
  PIPEDRIVE
  CUSTOM
}

model CRMIntegration {
  id              String      @id @default(uuid())
  businessId      String
  provider        CRMProvider
  
  // Status & Configuration
  enabled         Boolean     @default(true)
  isActive        Boolean     @default(true)
  autoSync        Boolean     @default(true)
  
  // Credentials (Encrypted) - Stored in JSON for flexibility
  credentials     Json
  apiKey          String?
  apiSecret       String?
  accessToken     String?
  refreshToken    String?
  instanceUrl     String?
  
  // Sync Settings
  syncEnabled     Boolean     @default(true)
  syncContacts    Boolean     @default(true)
  syncLeads       Boolean     @default(true)
  syncOpportunities Boolean   @default(false)
  syncCases       Boolean     @default(false)
  fieldMapping    Json?
  settings        Json?
  
  // Status
  lastSyncAt      DateTime?
  lastSyncError   String?
  syncError       String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, provider])
  @@index([businessId])
  @@map("crm_integrations")
}

// ============================================
// RATE LIMITING & ABUSE DETECTION
// ============================================

model RateLimitConfig {
  id              String   @id @default(uuid())
  businessId      String
  
  // Basic Limits
  requestsPerMinute   Int  @default(60)
  requestsPerHour     Int  @default(1000)
  requestsPerDay      Int  @default(10000)
  
  // Message Limits
  maxMessagesPerDay   Int  @default(1000)
  maxMessagesPerHour  Int  @default(100)
  messageCooldownSeconds Int @default(0)
  monthlyMessageQuota Int  @default(10000)
  
  // Call Limits
  maxCallsPerDay      Int  @default(100)
  maxCallsPerHour     Int  @default(20)
  monthlyCallQuota    Int  @default(500)
  monthlySMQuota      Int  @default(1000)
  
  // Abuse Detection
  autoBlockAfterAbuseCount Int @default(5)
  requireVerification Boolean @default(false)
  
  // Custom Rules
  customRules     Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId])
  @@map("rate_limit_configs")
}

model RateLimitHit {
  id          String   @id @default(uuid())
  businessId  String
  customerId  String?
  
  // Hit Details
  endpoint    String
  hitType     String   // WARNING, BLOCKED
  requestCount Int
  
  createdAt   DateTime @default(now())
  
  @@index([businessId, createdAt])
  @@index([customerId, createdAt])
  @@map("rate_limit_hits")
}

model AbuseLog {
  id          String   @id @default(uuid())
  businessId  String
  customerId  String?
  
  // Contact Info (for pattern detection)
  phone       String?
  email       String?
  ipAddress   String?
  fingerprint String?
  
  // Abuse Details
  abuseType   String   // SPAM, RATE_LIMIT, SUSPICIOUS
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  description String   @db.Text
  reason      String?  // Human-readable reason
  
  // Action Taken
  action      String   // WARN, THROTTLE, BLOCK, BAN
  
  // Metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([businessId, createdAt])
  @@index([customerId, createdAt])
  @@index([abuseType, createdAt])
  @@index([ipAddress])
  @@map("abuse_logs")
}

// ============================================
// AI ANALYTICS (Sentiment & Intent)
// ============================================

model SentimentLog {
  id              String   @id @default(uuid())
  businessId      String
  customerId      String
  conversationId  String?
  
  // Sentiment Data
  sentiment       String   // POSITIVE, NEGATIVE, NEUTRAL
  score           Decimal  @db.Decimal(4, 3) // -1 to 1
  confidence      Decimal  @db.Decimal(4, 3)
  
  // Context
  channel         Channel?
  messageContent  String?  @db.Text
  alertTriggered  Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@index([businessId, createdAt])
  @@index([customerId, createdAt])
  @@index([sentiment, createdAt])
  @@map("sentiment_logs")
}

model IntentLog {
  id              String   @id @default(uuid())
  businessId      String
  customerId      String
  conversationId  String?
  
  // Intent Data
  intent          String
  confidence      Decimal  @db.Decimal(4, 3)
  entities        Json?
  urgency         Int      @default(0) // 0-10
  
  // Context
  channel         Channel?
  messageContent  String?  @db.Text
  
  createdAt       DateTime @default(now())
  
  @@index([businessId, createdAt])
  @@index([customerId, createdAt])
  @@index([intent, createdAt])
  @@map("intent_logs")
}

// ============================================
// AUDIT LOG
// ============================================

enum AuditAction {
  CUSTOMER_CREATED
  CUSTOMER_UPDATED
  CUSTOMER_DELETED
  CUSTOMER_VERIFIED
  CUSTOMER_BLOCKED
  CUSTOMER_UNBLOCKED
  
  BUSINESS_CREATED
  BUSINESS_UPDATED
  BUSINESS_DELETED
  
  CONVERSATION_CREATED
  CONVERSATION_CLOSED
  CONVERSATION_TRANSFERRED
  MESSAGE_SENT
  MESSAGE_DELETED
  
  CAMPAIGN_CREATED
  CAMPAIGN_UPDATED
  CAMPAIGN_EXECUTED
  CAMPAIGN_DELETED
  
  AI_CONFIG_UPDATED
  CREDITS_ADDED
  CREDITS_DEDUCTED
  
  LOGIN_SUCCESS
  LOGIN_FAILED
  PASSWORD_CHANGED
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model AuditLog {
  id            String        @id @default(uuid())
  timestamp     DateTime      @default(now())
  
  // Actors
  businessId    String?
  customerId    String?
  adminId       String?       // Clerk user ID for admin actions
  
  // Action Details
  action        AuditAction
  severity      AuditSeverity @default(INFO)
  resource      String
  resourceId    String
  description   String        @db.Text
  
  // Data Changes
  oldValue      Json?
  newValue      Json?
  
  // Metadata
  metadata      Json?
  
  @@index([businessId, timestamp])
  @@index([customerId, timestamp])
  @@index([adminId, timestamp])
  @@index([action, timestamp])
  @@index([severity, timestamp])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

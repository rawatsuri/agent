# Render Blueprint - Backend Only
# Deploys only the Node.js API and Python Voice Bridge

services:
  # 1. Node.js Backend API Service
  - type: web
    name: omnichannel-ai-api
    runtime: node
    buildCommand: chmod +x render-build.sh && ./render-build.sh
    startCommand: chmod +x render-start.sh && ./render-start.sh
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: omnichannel-ai-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: omnichannel-ai-redis
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: CLERK_SECRET_KEY
        sync: false
      - key: CLERK_PUBLISHABLE_KEY
        sync: false
      - key: EXOTEL_API_KEY
        sync: false
      - key: EXOTEL_API_TOKEN
        sync: false
      - key: EXOTEL_SID
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: META_APP_ID
        sync: false
      - key: META_APP_SECRET
        sync: false
      - key: META_ACCESS_TOKEN
        sync: false
      - key: WHATSAPP_PHONE_NUMBER_ID
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: AZURE_SPEECH_KEY
        sync: false
      - key: AZURE_SPEECH_REGION
        sync: false
      - key: VOICE_BRIDGE_URL
        fromService:
          type: web
          name: omnichannel-ai-voice
          property: host
      - key: INTERNAL_API_KEY
        sync: false
    healthCheckPath: /health
    autoDeploy: true
    plan: standard

  # 2. Python Voice Bridge Service
  - type: web
    name: omnichannel-ai-voice
    runtime: python
    buildCommand: chmod +x voice-bridge/render-build.sh && ./voice-bridge/render-build.sh
    startCommand: chmod +x voice-bridge/render-start.sh && ./voice-bridge/render-start.sh
    envVars:
      - key: PYTHONPATH
        value: .
      - key: PORT
        value: 10000
      - key: NODE_API_URL
        fromService:
          type: web
          name: omnichannel-ai-api
          property: host
      - key: INTERNAL_API_KEY
        sync: false
      - key: AZURE_TTS_KEY
        sync: false
      - key: AZURE_TTS_REGION
        sync: false
      - key: EXOTEL_API_KEY
        sync: false
      - key: EXOTEL_API_TOKEN
        sync: false
      - key: EXOTEL_SID
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: WHISPER_MODEL
        value: base
    healthCheckPath: /health
    autoDeploy: true
    plan: standard

databases:
  # PostgreSQL Database
  - name: omnichannel-ai-db
    databaseName: omnichannel_ai
    user: omnichannel_ai_user
    plan: standard
    postgresMajorVersion: 15
    ipAllowList: []

  # Redis for caching and queues
  - type: redis
    name: omnichannel-ai-redis
    plan: starter
    ipAllowList: []
